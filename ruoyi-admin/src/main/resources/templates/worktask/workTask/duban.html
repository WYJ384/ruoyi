<!DOCTYPE HTML>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<meta charset="utf-8">
<head th:include="include :: header"></head>
<link th:href="@{/ajax/libs/bootstrap-fileinput-master/css/fileinput.css}" media="all" rel="stylesheet"
      type="text/css"/>
<link th:href="@{/ajax/libs/bootstrap-fileinput-master/themes/explorer-fas/theme.css}" media="all" rel="stylesheet"
      type="text/css"/>
<link rel="stylesheet" th:href="@{/css/flowChart.css}"/>
<style type="text/css">
    /* attch */
    .attch-list {
        position: relative;
        padding: 5px 0;
        border-top: #d9d9d9 1px solid;
        border-bottom: #d9d9d9 1px solid;
        display: none;
    }

    .attch-item {
        line-height: 28px;
        color: #888;
        overflow: hidden;
    }

    .atch-itm-icon {
        float: left;
        width: 20px;
        height: 20px;
        margin: 3px 5px 0 0;
        background: url(../images/ioop-icon-3.5.png) 0 -165px no-repeat;
    }

    .atch-itm-icon.xls, .atch-itm-icon.xlsx {
        background-position: -25px -165px;
    }

    .atch-itm-icon.doc, .atch-itm-icon.docx {
        background-position: -50px -165px;
    }

    .atch-itm-icon.ppt, .atch-itm-icon.pptx {
        background-position: -75px -165px;
    }

    .atch-itm-icon.txt {
        background-position: -100px -165px;
    }

    .atch-itm-icon.rm, .atch-itm-icon.rmvb, .atch-itm-icon.swf, .atch-itm-icon.mp4, .atch-itm-icon.avi {
        background-position: -125px -165px;
    }

    .atch-itm-icon.pdf {
        background-position: -150px -165px;
    }

    .atch-itm-icon.rar, .atch-itm-icon.zip {
        background-position: -175px -165px;
    }

    .atch-itm-icon.jpg, .atch-itm-icon.png, .atch-itm-icon.gif {
        background-position: -200px -165px;
    }

    .atch-itm-icon.html {
        background-position: -225px -165px;
    }

    .atch-itm-name, .atch-itm-size, .atch-itm-state, .atch-itm-upler {
        float: left;
        margin: 0 10px 0 0;
    }

    .atch-itm-name {
        text-decoration: none;
        color: #888;
        cursor: pointer;
    }

    .atch-itm-name:hover {
        text-decoration: underline;
        color: #5184ec;
    }

    .atch-itm-view, .atch-itm-dload, .atch-itm-del, .atch-itm-trans {
        margin: 0 0 0 10px;
        text-decoration: none;
        color: #5184ec;
        cursor: pointer;
    }

    .atch-itm-view:hover, .atch-itm-dload:hover, .atch-itm-del:hover, .atch-itm-trans:hover {
        text-decoration: underline;
    }

    .atch-itm-prog {
        background-color: #fff;
        border: #d6dee2 1px solid;
    }

    .aitm-prog-bar {
        width: 0;
        height: 6px;
        background-color: #51a3d8;
    }

    .atch-dlad-all {
        position: absolute;
        top: 15px;
        right: 0;
    }

    .atch-dlad-all a {
        display: block;
        width: 64px;
        height: 24px;
        line-height: 24px;
        text-decoration: none;
        padding: 3px 10px;
        background: #74cc39;
        text-align: center;
        color: #fff;
        cursor: pointer;
    }

    .atch-dlad-all a:hover {
        background: #3cb536;
    }

    .attch-list {
        position: relative;
        padding: 5px 0;
        border-top: #d9d9d9 1px solid;
        border-bottom: #d9d9d9 1px solid;
        display: none;
    }

    .attch-item {
        line-height: 26px;
        color: #888;
        overflow: hidden;
    }

    .attch-itm-icon {
        float: left;
        width: 20px;
        height: 20px;
        margin: 3px 5px 0 0;
        background: url(img/ioop-icon-3.5.png) 0 -165px no-repeat;
    }

    .attch-itm-icon.xls, .attch-itm-icon.xlsx {
        background-position: -25px -165px;
    }

    .attch-itm-icon.doc, .attch-itm-icon.docx {
        background-position: -50px -165px;
    }

    .attch-itm-icon.ppt, .attch-itm-icon.pptx {
        background-position: -75px -165px;
    }

    .attch-itm-icon.txt {
        background-position: -100px -165px;
    }

    .attch-itm-icon.rm, .attch-itm-icon.rmvb, .attch-itm-icon.swf, .attch-itm-icon.mp4, .attch-itm-icon.avi {
        background-position: -125px -165px;
    }

    .attch-itm-icon.pdf {
        background-position: -150px -165px;
    }

    .attch-itm-icon.rar, .attch-itm-icon.zip {
        background-position: -175px -165px;
    }

    .attch-itm-icon.jpg, .attch-itm-icon.png, .attch-itm-icon.gif {
        background-position: -200px -165px;
    }

    .attch-itm-icon.html {
        background-position: -225px -165px;
    }

    .attch-itm-name, .attch-itm-size, .attch-itm-state, .attch-itm-upler {
        float: left;
        margin-right: 10px;
    }

    .attch-itm-name {
        text-decoration: none;
        color: #888;
        cursor: pointer;
    }

    .attch-itm-name:hover {
        text-decoration: underline;
        color: #5184ec;
    }

    .attch-itm-view, .attch-itm-dload, .attch-itm-delete, .attch-itm-trans {
        margin-left: 10px;
        text-decoration: none;
        color: #5184ec;
        cursor: pointer;
    }

    .attch-itm-view:hover, .attch-itm-dload:hover, .attch-itm-delete:hover, .attch-itm-trans:hover {
        text-decoration: underline;
    }

    .attch-itm-progs {
        background-color: #fff;
        border: #d6dee2 1px solid;
    }

    .aitm-progs-bar {
        width: 0;
        height: 6px;
        background-color: #51a3d8;
    }

    .attch-dload-all {
        position: absolute;
        top: 15px;
        right: 0;
    }

    .attch-dload-all a {
        display: block;
        width: 64px;
        height: 14px;
        line-height: 14px;
        text-decoration: none;
        padding: 8px 10px;
        background-color: #74cc39;
        text-align: center;
        color: #fff;
        cursor: pointer;
    }

    .attch-dload-all a:hover {
        background-color: #3cb536;
    }
</style>
<body class="white-bg">
<div class="wrapper wrapper-content animated fadeInRight ibox-content">
    <form class="form-horizontal m" id="form-workTask-edit" th:object="${workTask}" enctype="multipart/form-data">
        <div class="row">
            <div class="col-sm-12">
                <div class="form-group">
                    <label class="col-sm-2 control-label"><span style="color: red; ">*</span>任务名称：</label>
                    <div class="col-sm-10">
                        <input id="workName" th:field="*{workName}" readonly name="workName" class="form-control"
                               type="text">
                    </div>
                </div>
            </div>
        </div>


        <div class="row">
            <div class="col-sm-12">
                <div class="form-group">
                    <label class="col-xs-2 control-label">主要目标：</label>
                    <div class="col-xs-10">

                        <div class="well" th:utext="${workTask.description}"></div>

                        <!--                        <textarea readonly name="description" th:field="*{description}" autocomplete="off"-->
                        <!--                                  maxlength="500"-->
                        <!--                                  class="form-control" rows="3"></textarea>-->
                    </div>
                </div>
            </div>
        </div>


        <div class="row">
            <div class="col-sm-12">
                <div class="form-group">
                    <label class="col-xs-2 control-label">附件：</label>
                    <div class="col-xs-10">
                        <p th:each="taskfile:${workTaskFiles}">
                            <a th:onclick="'javascript:downloadFile(\''+${taskfile.id}+'\');'"
                               th:text="${taskfile.fileName}"></a>
                        </p>

                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12">
                <div class="form-group">
                    <label class="col-xs-2 control-label">备注：</label>
                    <div class="col-xs-10">
                        <textarea name="remark" readonly autocomplete="off" th:field="*{remark}" maxlength="500"
                                  class="form-control" rows="3"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>


<div class="wrapper wrapper-content animated fadeInRight ibox-content">

    <form class="form-horizontal m" id="form-workTaskActivity-edit" th:object="${workTaskActivity}"
          enctype="multipart/form-data">
        <input id="id" name="id" th:field="*{id}" type="hidden">
        <input name="taskId" th:value="${taskId}" type="hidden">
        <input name="taskKey" id="taskKey" th:value="${taskKey}" type="hidden">
        <input name="workTaskId" id="workTaskId" th:value="${workTaskActivity.workTaskId}" type="hidden">
        <input name="submitType" id="submitType" type="hidden">
        <div class="row">
            <div class="col-sm-12">
                <div class="form-group">
                    <label class="col-sm-2 control-label">任务目标：</label>
                    <div class="col-sm-10">
                        <div class="well" th:utext="${workTaskActivity.target}"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12">
                <div class="form-group">
                    <label class="col-sm-2 control-label">要求完成时间：</label>
                    <div class="col-sm-10">
                        <input name="updateTime" readonly
                               th:value="${#dates.format(workTaskActivity?.updateTime, 'yyyy-MM-dd HH:mm:ss')}"
                               class="form-control"
                               type="text">
                    </div>
                </div>
            </div>
        </div>

        <div class="row" th:if="${taskKey=='zhurenduban'}">
            <div class="col-sm-12">
                <div class="form-group">
                    <label class="col-sm-2 control-label">执行人：</label>
                    <div class="col-sm-10">
                        <select id="userIds" name="userIds" class="form-control select2-hidden-accessible">
                            <option value=""></option>
                            <option th:each="user:${users}" th:value="${user.loginName}"
                                    th:text="${user.userName}"></option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="row" th:if="${taskKey=='gerentijiao'}">
            <div class="col-sm-12">
                <div class="form-group">
                    <label class="col-sm-2 control-label"><span style="color: red; ">*</span>汇报内容：</label>
                    <div class="col-sm-10">
                        <!--                       <textarea th:text="${workTaskActivity.content}" rows="6" name="content"-->
                        <!--                                 class="form-control"></textarea>-->

                        <script id="target" name="content" type="text/plain" style="width:1024px;height:500px;"
                                th:utext="${workTaskActivity.content}"></script>

                    </div>
                </div>
            </div>
        </div>
<!--        <div class="row" th:if="${taskKey=='gerentijiao'}">-->
<!--            <div class="col-sm-12">-->
<!--                <div class="form-group">-->
<!--                    <label class="col-sm-2 control-label">附件：</label>-->
<!--                    <div class="col-sm-10">-->
<!--                        <input type="file" id="file" name="file">-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
        <div class="row" th:if="${taskKey=='lingdaopingfen'}">
            <div class="col-sm-12">
                <div class="form-group">
                    <label class="col-sm-2 control-label">汇报内容：</label>
                    <div class="col-sm-10">
                        <!--                       <textarea th:text="${workTaskActivity.content}" readonly rows="6" name="content"-->
                        <!--                                 class="form-control"></textarea>-->
                        <div class="well" th:utext="${workTaskActivity.content}"></div>

                    </div>
                </div>
            </div>
        </div>
        <!--        <div class="row" th:if="${taskKey=='lingdaopingfen'}">-->
        <!--            -->
        <!--        </div>-->
        <div class="col-sm-12">
            <div class="form-group">
                <label class="col-sm-2 control-label">任务附件：</label>
                <div class="col-sm-10">
                    <!--                    <p th:each="taskfile:${workTaskActivity.workTaskFiles}">-->
                    <!--                        <a th:onclick="'javascript:downloadFile(\''+${taskfile.id}+'\');'"-->
                    <!--                           th:text="${taskfile.fileName}"></a>-->
                    <!--                    </p>-->
                    <ul id="task_file_list" class="attch-list" style="display: block;">
                        <li id="file_file_0_0" class="attch-item" th:each="file:${workTaskActivity.workTaskFiles}"><i
                                class="attch-itm-icon xlsx"></i><a
                                class="attch-itm-name"
                                th:href="'/worktask/workTaskFile/downloadFile/'+${file.id}"
                                target="_blank" th:text="${file.fileName}" th:title="${file.fileName}"></a><span
                                class="attch-itm-size"></span><span class="attch-itm-state"></span><a
                                class="attch-itm-dload"
                                th:href="'/worktask/workTaskFile/downloadFile/'+${file.id}"
                                target="_blank">下载</a>
                            <a class="attch-itm-delete" th:onclick="'javascript:deleteFile(\''+${file.id}+'\');'">删除</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="row" th:if="${taskKey=='lingdaopingfen'}">
            <div class="col-sm-12">
                <div class="form-group">
                    <label class="col-sm-2 control-label"><span style="color: red; ">*</span>任务得分：</label>
                    <div class="col-sm-10">
                        <input name="targetScore" id="targetScore" th:value="${workTaskActivity.targetScore}"
                               class="form-control"
                               type="text">
                    </div>
                </div>
            </div>
            <div class="col-sm-12">
                <div class="form-group">
                    <label class="col-sm-2 control-label">批示：</label>
                    <div class="col-sm-10">
                        <textarea name="repContent" id="repContent" th:text="${workTaskActivity.repContent}"
                                  class="form-control"></textarea>
                    </div>
                </div>
            </div>
        </div>
        <!--<h4>事件时间轴</h4>-->
        <!--<hr />-->
        <!--事件时间轴-->
        <div class="flowChart">
            <!--左侧轴-->
            <div class="flowChart-left">
                <!--虚线-->
                <div class="dashed"></div>
            </div>
            <!--右侧内容-->
            <div class="flowChart-right">
                <!--一个节点-->
                <div class="oneNode" th:each="his: ${workTaskActivity.historyTaskVos}">
                    <!--左侧小球-->
                    <div class="check check-danger" th:text="${his.activityName}">
                    </div>
                    <div class="tag-boder">
                        <div class="tag">
                        </div>
                    </div>
                    <!--右侧内容-->
                    <div class="NodeDetail">
                        <!--上-->
                        <div class="NodeDetail-title">
                            <!--头像-->
                            <!--<img src="img/headImg.jpg" />-->
                            <!--内容-->
                            <div class="details">
                                <h4 th:text="${his.assignee==null?his.activityName:'任务办理人：'+his.assignee}"></h4>
                                <!--                                    -->
                                <h4 th:text="${his.queryVariables==null?'':'下一步任务办理人：'+his.queryVariables}"></h4>
                            </div>
                        </div>
                        <!--中-->
                        <div class="NodeDetail-content">
                            <span class="badge">任务内容:</span>

                            <p th:utext="${his.description}"></p>
                        </div>
                        <!--下-->
                        <div class="NodeDetail-footer">
                            <span th:text="${#dates.format(his.endTime, 'yyyy-MM-dd HH:mm')}">2017-10-31 22:22:31</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!--<h4>事件时间轴</h4>-->

        <div class="row">
            <div class="col-sm-offset-5 col-sm-10">
                <button type="button" class="btn btn-sm btn-primary" onclick="submitHandler(1)"><i
                        class="fa fa-check"></i>保 存
                </button>
                <button type="button" class="btn btn-sm btn-primary" onclick="submitHandler(2)"><i
                        class="fa fa-check"></i>提 交
                </button>
                &nbsp;
                <button type="button" class="btn btn-sm btn-danger" onclick="closeItem()"><i
                        class="fa fa-reply-all"></i>关 闭
                </button>
            </div>
        </div>
    </form>
</div>
<div th:include="include::footer"></div>

<script th:src="@{/ajax/libs/select/select2.js}"></script>
<script th:src="@{/ajax/libs/bootstrap-fileinput-master/js/fileinput.js}" type="text/javascript"></script>
<script th:src="@{/ajax/libs/bootstrap-fileinput-master/js/locales/zh.js}" type="text/javascript"></script>
<script type="text/javascript" charset="utf-8" th:src="@{/ueditor/ueditor.config.js}"></script>
<script type="text/javascript" charset="utf-8" th:src="@{/ueditor/ueditor.all.js}"></script>
<!--建议手动加在语言，避免在ie下有时因为加载语言失败导致编辑器加载失败-->
<!--这里加载的语言文件会覆盖你在配置项目里添加的语言类型，比如你在配置项目里配置的是英文，这里加载的中文，那最后就是中文-->
<script type="text/javascript" charset="utf-8" th:src="@{/ueditor/lang/zh-cn/zh-cn.js}"></script>

<script type="text/javascript">
    $(function () {
        // var ue = UE.getEditor('target');

        var editor= UE.getEditor('target', {
            toolbars: [
                [
                    'fontfamily', //字体
                    'undo', //撤销
                    'redo', //重做
                    'emotion',
                    //'formatmatch', //格式刷
                    //'pasteplain', //纯文本粘贴模式
                    //'selectall', //全选
                    'simpleupload', //单图上传
                    'insertimage', //多图上传
                    'insertvideo',//视频上传
                    'spechars', //特殊字符
                    'justifyleft', //居左对齐
                    'justifyright', //居右对齐
                    'justifycenter', //居中对齐
                    'justifyjustify', //两端对齐
                    'forecolor', //字体颜色
                    'attachment', //附件
                    //'lineheight', //行间距
                    //'searchreplace', //查询替换
                ]
            ],
            autoHeightEnabled: true,
            autoFloatEnabled: true,
            // initialFrameWidth:720,//初始化编辑器宽度，默认1000
            // initialFrameHeight:320,  //初始化编辑器高度，默认320
            enableAutoSave :true,//启用自动保存 [默认值：true]
            saveInterval:500, //[默认值：500] //自动保存间隔时间，单位ms
            pasteplain :true // [默认值：false] 是否默认为纯文本粘贴。false为不使用纯文本粘贴，true为使用纯文本粘贴
        });

    });
    // $('#file').fileinput({
    //     language: 'zh',
    //     showPreview: false, //是否显示预览
    //     showUpload: false, //是否显示上传按钮
    //     showRemove: true, //显示移除按钮
    // });
    var prefix = ctx + "worktask/workTaskActivity";
    $("#form-workTaskActivity-edit").validate({
        submitHandler: function (form) {
            var formData = new FormData($("#form-workTaskActivity-edit")[0]);
            if ($("#taskKey").val() == "zhurenduban") {
                var userIds = $.form.selectSelects("userIds");
                if (userIds == "") {
                    $.modal.alert("请选择任务执行人", "error");
                    return;
                }
                formData.append('userIds', userIds);
            }

            var taskKey = '[[${taskKey}]]';
            if(taskKey=='lingdaopingfen'){
                layer.tips("请输入得分", '#targetScore', {
                    tips: [1, '#f00'], //1-上，2-右，3-下，4-左
                    time: 4000,
                    area: ['300px', 'auto'],
                })
            }
            // if ($('#file')[0]) {
            //     formData.append('file', $('#file')[0].files[0]);
            // }

            $.ajax({
                url: prefix + "/edit",
                type: 'post',
                cache: false,
                data: formData,
                processData: false,
                contentType: false,
                dataType: "json",
                beforeSend: function () {
                    $.modal.loading("正在处理中，请稍后...");
                },
                success: function (result) {
                    $.operate.successTabCallback(result);
                }
            });

        },
        rules: {
            target: {
                required: true,
            },
            targetScore: {
                required: true,
            },
        },
        focusCleanup: true
    });

    function submitHandler(submitType) {
        $("#submitType").val(submitType);
        $("#form-workTaskActivity-edit").submit();
    }

    function downloadFile(fileId) {
        window.location.href = ctx + "worktask/workTaskFile/downloadFile/" + fileId;
    }

    function deleteFile(id) {


        $.modal.confirm("确定删除该附件吗？", function () {
            var data = {"ids": id};
            $.ajax({
                url: ctx + "worktask/workTaskFile/delete",
                type: "post",
                data: data,
                beforeSend: function () {
                    $.modal.loading("正在处理中，请稍后...");
                },
                success: function (result) {
                    $.modal.closeLoading();
                    window.location.reload()
                }
            })
        });
    }

</script>
</body>
</html>
